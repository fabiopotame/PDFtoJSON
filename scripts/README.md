# Database Initialization Scripts

This directory contains scripts for Oracle database initialization and configuration.

## Files

### `init_database.py`
Main script that:
- Checks if the `PDFTOJSON` table exists
- Creates the table if it doesn't exist
- Creates helper function `get_json_varchar`
- Checks if views exist
- Creates views `VW_PDFTOJSON_SECTIONS` and `VW_PDFTOJSON_FIELDS`

### `start.sh`
Startup script used by Docker that:
- Checks if the `.env` file exists
- Executes database initialization
- Starts the Flask application

## Configuration

### 1. `.env` File
Create a `.env` file in the project root with:

```env
# Oracle Database Configuration
ORACLE_USERNAME=ADMIN
ORACLE_PASSWORD=YourPasswordHere
ORACLE_SERVICE_NAME=nh66vvfwukxku4dc_high

# Application Configuration
FLASK_ENV=development
FLASK_DEBUG=true
PORT=8085
```

### 2. Oracle Wallet
Make sure Oracle wallet files are in the `oracle/` folder:
- `tnsnames.ora`
- `sqlnet.ora`
- `cwallet.sso`
- `ewallet.pem`
- `ewallet.p12`

## Execution

### Manual Execution
```bash
# Run only database initialization
python3 scripts/init_database.py

# Run with complete script
bash scripts/start.sh
```

### Docker Execution
```bash
# Build and run with Docker Compose
docker-compose up --build

# Or just run if already built
docker-compose up
```

## Created Structure

### PDFTOJSON Table
```sql
CREATE TABLE PDFTOJSON (
    ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    DOCUMENT_TYPE VARCHAR2(50) NOT NULL,
    DOCUMENT_FILENAME VARCHAR2(255) NOT NULL,
    DOCUMENT_PATH VARCHAR2(500) NOT NULL,
    DATE_CREATED TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CONTENT CLOB NOT NULL,
    CONSTRAINT chk_content_is_json CHECK (CONTENT IS JSON)
);
```

### Indexes
- `idx_pdftojson_type` - Index by document type
- `idx_pdftojson_filename` - Index by filename
- `idx_pdftojson_created` - Index by creation date

### Views
- `VW_PDFTOJSON_SECTIONS` - Extracts data from document sections
- `VW_PDFTOJSON_FIELDS` - Extracts data from individual fields

### Helper Function
- `get_json_varchar` - Converts CLOB to VARCHAR2 for JSON processing

## Logs

The script generates detailed logs showing:
- Oracle connection status
- Table/view existence verification
- Database object creation
- Errors and successes

## Troubleshooting

### Error: "ORACLE_PASSWORD not found"
- Check if the `.env` file exists
- Confirm if the `ORACLE_PASSWORD` variable is defined

### Error: "Wallet file not found"
- Check if wallet files are in the `oracle/` folder
- Confirm if the `sqlnet.ora` file has the correct path

### Error: "Failed to connect to Oracle"
- Check credentials in the `.env` file
- Confirm if the Oracle service is accessible
- Verify if the wallet is configured correctly

## CI/CD Integration

The script can be integrated into CI/CD pipelines to:
- Automatically configure development environments
- Prepare databases for testing
- Run migrations in production 